## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è —Ä–µ–ø–ª–∏–∫ (Replica Lag)

**–°—É—Ç—å**: –í AlwaysOn –µ—Å—Ç—å –¥–≤–µ –∫–ª—é—á–µ–≤—ã–µ –æ—á–µ—Ä–µ–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç "–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ" –≤—Ç–æ—Ä–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏. –ò—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞:
1.  **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –±—ã—Å—Ç—Ä–æ –¥–∞–Ω–Ω—ã–µ —É—Ö–æ–¥—è—Ç —Å –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏?** (Send Queue)
2.  **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –±—ã—Å—Ç—Ä–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–π?** (Redo Queue)

–≠—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –≤–∞—à–µ–≥–æ **—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ RPO** (–≤ —Å–ª—É—á–∞–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏) –∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ failover (–≤ —Å–ª—É—á–∞–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π).

### **1. –î–≤–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ –∏ –∫–∞–∫ –∏—Ö –∏–∑–º–µ—Ä–∏—Ç—å**

–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± ‚Äî –∑–∞–ø—Ä–æ—Å –∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º (DMV) –Ω–∞ **–ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ**.

```sql
-- –ó–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ –ü–ï–†–í–ò–ß–ù–û–ô —Ä–µ–ø–ª–∏–∫–µ)
SELECT
    -- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
    ag.name AS [AG Name],
    ar.replica_server_name AS [Replica Server],
    db_name(drs.database_id) AS [Database],
    -- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –û–¢–°–¢–ê–í–ê–ù–ò–Ø (–≤ –ö–ë)
    drs.log_send_queue_size AS [Send Queue (KB)], -- –ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    drs.redo_queue_size AS [Redo Queue (KB)],     -- –ù–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    -- –ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    drs.synchronization_percent AS [Sync %],
    -- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    drs.synchronization_state_desc AS [Sync State],
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ª–∞–≥–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏)
    drs.last_commit_time AS [Last Commit Time (Primary)],
    drs.last_commit_lsn
FROM sys.dm_hadr_database_replica_states drs
JOIN sys.availability_replicas ar ON drs.replica_id = ar.replica_id
JOIN sys.availability_groups ag ON ag.group_id = drs.group_id
ORDER BY ag.name, ar.replica_server_name, [Database];
```

**–ö–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

| –ú–µ—Ç—Ä–∏–∫–∞ | –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä) | –ì–¥–µ –ø—Ä–æ–±–ª–µ–º–∞? |
| :--- | :--- | :--- | :--- |
| **`log_send_queue_size`** | –û–±—ä–µ–º –∑–∞–ø–∏—Å–µ–π –∂—É—Ä–Ω–∞–ª–∞ (–≤ –ö–ë), –∫–æ—Ç–æ—Ä—ã–µ **–µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã** —Å –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏. | –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–æ—Å—Ç > 100 000 –ö–ë (~100 –ú–ë) | **–°–µ—Ç—å** –∏–ª–∏ **–¥–∏—Å–∫–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏**. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—É—é –∑–∞–¥–µ—Ä–∂–∫—É, –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å, –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –¥–∏—Å–∫ log-—Ñ–∞–π–ª–∞ –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ. |
| **`redo_queue_size`** | –û–±—ä–µ–º –∑–∞–ø–∏—Å–µ–π –∂—É—Ä–Ω–∞–ª–∞ (–≤ –ö–ë), –∫–æ—Ç–æ—Ä—ã–µ **–ø–æ–ª—É—á–µ–Ω—ã, –Ω–æ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã** –∫ –¥–∞–Ω–Ω—ã–º –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ. | –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–æ—Å—Ç > 50 000 –ö–ë (~50 –ú–ë) | **–†–µ—Å—É—Ä—Å—ã –≤—Ç–æ—Ä–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏** (CPU, Disk I/O). –ß–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –Ω–∞–≥—Ä—É–∑–∫–∞ –æ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ (Readable Secondary) –∏–ª–∏ –±–æ–ª—å—à–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. |

**–°–æ—Å—Ç–æ—è–Ω–∏—è (`synchronization_state_desc`):**
*   `SYNCHRONIZED`: –†–µ–ø–ª–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. **–¢–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–æ–∑–º–æ–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover** –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ä–µ–ø–ª–∏–∫.
*   `SYNCHRONIZING`: –†–µ–ø–ª–∏–∫–∞ –¥–æ–≥–æ–Ω—è–µ—Ç. –≠—Ç–æ –Ω–æ—Ä–º–∞ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ä–µ–ø–ª–∏–∫ –∏–ª–∏ –ø–æ—Å–ª–µ —Å–±–æ—è.
*   `NOT SYNCHRONIZING`: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π.

### **2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (AlwaysOn Dashboard)**

–í SSMS —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É:
1.  –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —ç–∫–∑–µ–º–ø–ª—è—Ä—É SQL Server (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –∫ –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ).
2.  –í **–û–±–æ–∑—Ä–µ–≤–∞—Ç–µ–ª–µ –æ–±—ä–µ–∫—Ç–æ–≤** —Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ —É–∑–µ–ª **–í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ AlwaysOn**.
3.  –ü—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –º—ã—à–∏ —â–µ–ª–∫–Ω–∏—Ç–µ –Ω–∞ –Ω—É–∂–Ω—É—é **–ì—Ä—É–ø–ø—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏** –∏ –≤—ã–±–µ—Ä–∏—Ç–µ **–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**.

–ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞–≥–ª—è–¥–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–ª–∏–∫, –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç **–æ—á–µ—Ä–µ–¥—å –ø–æ–≤—Ç–æ—Ä–∞ (Redo Queue)** –∏ **–æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏ (Send Queue)** –≤ –≤–∏–¥–µ –ø–æ–ª–æ—Å–æ–∫.

### **3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π**

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω-—Å—Ä–µ–¥—ã –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–±–æ—Ä —ç—Ç–∏—Ö –º–µ—Ç—Ä–∏–∫ –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Zabbix, Prometheus, SCOM) –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã.

**–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ SQL Server Agent:**
–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∏—Å—å–º–æ, –µ—Å–ª–∏ –ø–æ—Ä–æ–≥ –ø—Ä–µ–≤—ã—à–µ–Ω.

```sql
-- –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è-–æ–ø–æ–≤–µ—â–µ–Ω–∏—è
IF EXISTS (
    SELECT 1
    FROM sys.dm_hadr_database_replica_states drs
    WHERE drs.redo_queue_size > 51200 -- –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ > 50 –ú–ë
       OR drs.log_send_queue_size > 102400 -- –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ > 100 –ú–ë
)
BEGIN
    -- –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –æ—Ç–ø—Ä–∞–≤–∫–∏ email
    -- EXEC msdb.dbo.sp_send_dbmail ...
    PRINT '–í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∏!';
END
```

### **4. –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Ä–æ—Å—Ç–∞ –æ—á–µ—Ä–µ–¥–µ–π**

**–ï—Å–ª–∏ —Ä–∞—Å—Ç–µ—Ç `log_send_queue_size` (–ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω–æ–π):**
1.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å: `ping`, `tracert`, —Å–µ—Ç–µ–≤—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ Performance Monitor (Network Interface\Bytes Total/sec, Output Queue Length).
2.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏—Å–∫–æ–≤—É—é –ø–æ–¥—Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ñ–∞–π–ª –∂—É—Ä–Ω–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–ª–æ–≥–∏—á–µ—Å–∫–∏–π –¥–∏—Å–∫: Avg. Disk sec/Write).

**–ï—Å–ª–∏ —Ä–∞—Å—Ç–µ—Ç `redo_queue_size` (–ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–π):**
1.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É CPU –∏ –¥–∏—Å–∫–æ–≤—É—é –ø–æ–¥—Å–∏—Å—Ç–µ–º—É –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ.
2.  –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ (–µ—Å–ª–∏ –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —á—Ç–µ–Ω–∏—è). –í–æ–∑–º–æ–∂–Ω–æ, —Ç—è–∂–µ–ª—ã–µ –æ—Ç—á–µ—Ç—ã –±–ª–æ–∫–∏—Ä—É—é—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–≤—Ç–æ—Ä–∞ (REDO).
3.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω–æ–π —Ä–µ–ø–ª–∏–∫–µ –≤–∫–ª—é—á–µ–Ω–æ **—É—Å–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Accelerated Database Recovery, ADR)** (–µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è SQL Server 2019+), —ç—Ç–æ –º–æ–∂–µ—Ç —É—Å–∫–æ—Ä–∏—Ç—å REDO.
