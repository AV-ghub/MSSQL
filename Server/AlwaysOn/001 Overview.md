---

### **MSSQL AlwaysOn Availability Groups: План подготовки**

### **1. Принципы развертывания (Два основных типа)**

**Рекеп:**
AlwaysOn AG — это решение высокого доступности (HA) и аварийного восстановления (DR), построенное на основе *группы доступности* — контейнера для одной или нескольких баз данных (User DB), которые реплицируются в виде единого целого. Ключевое понятие — **реплика** (экземпляр SQL Server).

**Два типа конфигураций:**

**A) AlwaysOn Availability Groups (Основной вариант)**
*   **Суть:** Репликация на уровне базы данных (от 1 до ~100 БД в группе). Данные физически находятся на каждом узле в своих файлах.
*   **Типы реплик:**
    *   **Первичная (Primary):** Принимает транзакции чтения/записи от клиентов. Поток транзакций (лог) отправляется на вторичные реплики.
    *   **Вторичная (Secondary):** Принимает поток логов от первичной. Может быть настроена для:
        *   **Резервного копирования (только с нее).**
        *   **Чтения (Readable Secondary):** Подключение для рабочих нагрузок `SELECT` (роутер на чтение).
        *   **Синхронной или асинхронной репликации.**
*   **Режимы доступности:**
    *   **Синхронная фиксация:** Транзакция фиксируется на первичной только после подтверждения, что лог записан на диск минимум на одной синхронной вторичной реплике. Гарантия zero data loss при отработке отказа (failover). Влияет на производительность записи из-за задержки сети.
    *   **Асинхронная фиксация:** Первичная фиксирует транзакцию немедленно, не дожидаясь вторичных. Риск потери данных при сбое. Используется обычно для реплик DR в другом ЦОДе.

**B) AlwaysOn Failover Cluster Instances (FCI) — Часто путают с AG**
*   **Суть:** Решение **высокой доступности (HA)** на уровне **экземпляра SQL Server**. Основано на отказоустойчивом кластере Windows Server (WSFC). Общее хранилище (SAN, iSCSI, SMB, Spaces Direct).
*   **Как работает:** Экземпляр SQL Server установлен на общем дисковом ресурсе. Активен только на одном узле кластера. При сбое происходит перемещение **всего экземпляра** и его ресурсов (включая системные БД) на другой узел кластера.
*   **Ключевое отличие от AG:** **Общее хранилище** (Single Point of Failure, если не реплицировано на уровне хранилища). Защищает от сбоя сервера/ОС, но не от повреждения данных на дисках.

**Часто используется вместе:** FCI (для защиты экземпляра) + AG (для репликации баз данных на другой FCI или standalone сервер) = максимальная отказоустойчивость.

**Готовы углубиться в архитектуру WSFC или роли кворума для AG?**

---

### **2. Вопросы обслуживания**

**Рекеп:**
*   **Патчинг и обновления:**
    *   **Порядок:** Всегда начинать с вторичных синхронных реплик -> ручной failover на обновленную реплику -> патчить старую первичную.
    *   **Откат:** Сложнее, требует планирования и возможных резервных копий.
*   **Добавление/удаление БД из группы:**
    *   Добавление требует полной резервной копии и восстановления на всех вторичных репликах с `NO RECOVERY`.
    *   Удаление не удаляет БД физически, лишь останавливает репликацию.
*   **Мониторинг:**
    *   Системные DMV: `sys.dm_hadr_availability_group_states`, `sys.dm_hadr_database_replica_states` (последняя `last_hardened_time`, `log_send_queue_size`, `redo_queue_size`).
    *   Панель AlwaysOn Dashboard в SSMS.
    *   Политика Health Check и автоматического failover.
*   **Резервное копирование:**
    *   Можно настроить предпочтительное место для резервных копий (первичная/вторичная).
    *   Полные и разностные копии — обычно на первичной. Копии журналов — **только на первичной**, если вторичная не настроена для резервного копирования.
*   **Индексы и статистика:** Обновляются независимо на каждой реплике. На readable secondary нужно следить за статистикой.

**Хотите детально разобрать процедуру планового обновления (rolling update) или анализ лагов репликации?**

---

### **3. Нюансы настройки**

**Рекеп:**
*   **Предварительные требования:** WSFC, одинаковые версии/editions SQL Server (Enterprise для >1 БД или readable secondary), включенная фича AlwaysOn, единый домен Active Directory, стабильная сеть.
*   **Эндпоинты:** AG используют специальный эндпоинт `DATABASE_MIRRORING` для обмена данными. Важно: одинаковый алгоритм шифрования, контроль доступа (правильные права).
*   **Создание группы:**
    1.  Создание AG на первичной реплике (указание баз, реплик, режимов, endpoints).
    2.  Подготовка вторичных: восстановление полной резервной копии и следующей журнальной с `WITH NORECOVERY`.
    3.  Присоединение вторичных реплик к группе.
*   **Конфигурация прослушивателя (Listener):**
    *   Виртуальное сетевое имя (VNN) и IP-адрес (можно несколько в разных подсетях), регистрируемое в DNS.
    *   Клиенты подключаются к нему, а не к физическим серверам. При failover соединение переключается прозрачно (при правильных параметрах строки подключения: `ApplicationIntent=ReadOnly` / `ReadWrite`, `MultiSubnetFailover=True`).
*   **Автоматический Failover:** Требует минимум **одной синхронной реплики** с автоматическим переводом в режим `AUTOMATIC` и настроенной политикой Health Check.

**Обсудим настройку распределенной группы доступности (Distributed AG) или тонкости работы с `ApplicationIntent`?**

---

### **4. Подводные камни**

**Рекеп:**
*   **Проблемы с кворумом WSFC:** Потеря кворума останавливает AG. Важно правильно настраивать голоса узлов и свидетеля (файловый ресурс или Azure Cloud Witness).
*   **Сетевые задержки:** При синхронной репликации напрямую влияют на производительность записи. Критично для географически распределенных реплик.
*   **Превышение RPO:** При асинхронной репликации вторичная реплика может отставать (lag). При сбое первичной данные, не пересланные на вторичную, будут потеряны.
*   **"Узкое место" на первичной:** Все данные для вторичных реплик проходят через один поток отправки логов (per database). Много БД или большая нагрузка — может возникнуть очередь отправки (send queue).
*   **"Узкое место" на вторичной:** Поток повтора (redo) может не успевать применять журналы, особенно при больших операциях (индексация, массовые вставки). Важен мониторинг `redo_queue_size`.
*   **Проблемы с прослушивателем:** DNS-кеширование, неправильные IP/маски подсетей, firewall.
*   **Ошибка "Database is not joined":** Частая проблема при добавлении БД, если не восстановлена последняя журнальная резервная копия перед присоединением.
*   **Темпоральные таблицы и `IDENTITY`:** Данные временных таблиц (`#temp`) не реплицируются. Столбцы `IDENTITY` могут вызвать конфликты при работе с readable secondary, если не использовать диапазоны.

**Готовы разобрать кейс по диагностике и устранению лага репликации (send/redo queue)?**

---

### **5. Возможные вопросы к собеседованию**

**Базовый уровень:**
1.  В чем разница между AlwaysOn Availability Group и Failover Cluster Instance?
2.  Объясните разницу между синхронной и асинхронной репликацией. Каковы trade-offs?
3.  Что такое прослушиватель (Listener) и для чего он нужен?
4.  Как обеспечить отказоустойчивость для одной базы данных на 3 узла с гарантией отсутствия потерь данных при сбое одного узла?
5.  Можно ли делать резервные копии с вторичной реплики? Какие?

**Продвинутый уровень:**
1.  Опишите процесс планового обновления (patching) сервера в конфигурации AG.
2.  Как вы будете диагностировать и устранять отставание (lag) вторичной реплики?
3.  Что такое кворум WSFC и почему он важен для AG? Какие варианты кворума вы знаете?
4.  Клиент жалуется на таймауты при подключении к прослушивателю после failover. В чем могут быть причины?
5.  Какие ограничения имеют readable secondary реплики? (блокировки, статистика, темпоральные таблицы и т.д.)
6.  Что такое распределенная группа доступности (Distributed AG) и какой сценарий она решает?
7.  Как работает автоматический failover и что может его заблокировать?

---
