### **MSSQL AlwaysOn Availability Groups: План подготовки**

### **1. Принципы развертывания (Два основных типа)**

**Рекеп:**
AlwaysOn AG — это решение высокого доступности (HA) и аварийного восстановления (DR), построенное на основе *группы доступности* — контейнера для одной или нескольких баз данных (User DB), которые реплицируются в виде единого целого. Ключевое понятие — **реплика** (экземпляр SQL Server).

**Два типа конфигураций:**

**A) AlwaysOn Availability Groups (Основной вариант)**
*   **Суть:** Репликация на уровне базы данных (от 1 до ~100 БД в группе). Данные физически находятся на каждом узле в своих файлах.
*   **Типы реплик:**
    *   **Первичная (Primary):** Принимает транзакции чтения/записи от клиентов. Поток транзакций (лог) отправляется на вторичные реплики.
    *   **Вторичная (Secondary):** Принимает поток логов от первичной. Может быть настроена для:
        *   **Резервного копирования (только с нее).**
        *   **Чтения (Readable Secondary):** Подключение для рабочих нагрузок `SELECT` (роутер на чтение).
        *   **Синхронной или асинхронной репликации.**
*   **Режимы доступности:**
    *   **Синхронная фиксация:** Транзакция фиксируется на первичной только после подтверждения, что лог записан на диск минимум на одной синхронной вторичной реплике. Гарантия zero data loss при отработке отказа (failover). Влияет на производительность записи из-за задержки сети.
    *   **Асинхронная фиксация:** Первичная фиксирует транзакцию немедленно, не дожидаясь вторичных. Риск потери данных при сбое. Используется обычно для реплик DR в другом ЦОДе.

**B) AlwaysOn Failover Cluster Instances (FCI) — Часто путают с AG**
*   **Суть:** Решение **высокой доступности (HA)** на уровне **экземпляра SQL Server**. Основано на отказоустойчивом кластере Windows Server (WSFC). Общее хранилище (SAN, iSCSI, SMB, Spaces Direct).
*   **Как работает:** Экземпляр SQL Server установлен на общем дисковом ресурсе. Активен только на одном узле кластера. При сбое происходит перемещение **всего экземпляра** и его ресурсов (включая системные БД) на другой узел кластера.
*   **Ключевое отличие от AG:** **Общее хранилище** (Single Point of Failure, если не реплицировано на уровне хранилища). Защищает от сбоя сервера/ОС, но не от повреждения данных на дисках.

**Часто используется вместе:** FCI (для защиты экземпляра) + AG (для репликации баз данных на другой FCI или standalone сервер) = максимальная отказоустойчивость.

---

### **2. Вопросы обслуживания**

**Рекеп:**
*   **Патчинг и обновления:**
    *   **Порядок:** Всегда начинать с вторичных синхронных реплик -> ручной failover на обновленную реплику -> патчить старую первичную.
    *   **Откат:** Сложнее, требует планирования и возможных резервных копий.
*   **Добавление/удаление БД из группы:**
    *   Добавление требует полной резервной копии и восстановления на всех вторичных репликах с `NO RECOVERY`.
    *   Удаление не удаляет БД физически, лишь останавливает репликацию.
*   **Мониторинг:**
    *   Системные DMV: `sys.dm_hadr_availability_group_states`, `sys.dm_hadr_database_replica_states` (последняя `last_hardened_time`, `log_send_queue_size`, `redo_queue_size`).
    *   Панель AlwaysOn Dashboard в SSMS.
    *   Политика Health Check и автоматического failover.
*   **Резервное копирование:**
    *   Можно настроить предпочтительное место для резервных копий (первичная/вторичная).
    *   Полные и разностные копии — обычно на первичной. Копии журналов — **только на первичной**, если вторичная не настроена для резервного копирования.
*   **Индексы и статистика:** Обновляются независимо на каждой реплике. На readable secondary нужно следить за статистикой.

---

### **3. Нюансы настройки**

**Рекеп:**
*   **Предварительные требования:** WSFC, одинаковые версии/editions SQL Server (Enterprise для >1 БД или readable secondary), включенная фича AlwaysOn, единый домен Active Directory, стабильная сеть.
*   **Эндпоинты:** AG используют специальный эндпоинт `DATABASE_MIRRORING` для обмена данными. Важно: одинаковый алгоритм шифрования, контроль доступа (правильные права).
*   **Создание группы:**
    1.  Создание AG на первичной реплике (указание баз, реплик, режимов, endpoints).
    2.  Подготовка вторичных: восстановление полной резервной копии и следующей журнальной с `WITH NORECOVERY`.
    3.  Присоединение вторичных реплик к группе.
*   **Конфигурация прослушивателя (Listener):**
    *   Виртуальное сетевое имя (VNN) и IP-адрес (можно несколько в разных подсетях), регистрируемое в DNS.
    *   Клиенты подключаются к нему, а не к физическим серверам. При failover соединение переключается прозрачно (при правильных параметрах строки подключения: `ApplicationIntent=ReadOnly` / `ReadWrite`, `MultiSubnetFailover=True`).
*   **Автоматический Failover:** Требует минимум **одной синхронной реплики** с автоматическим переводом в режим `AUTOMATIC` и настроенной политикой Health Check.

---

### **4. Подводные камни**

**Рекеп:**
*   **Проблемы с кворумом WSFC:** Потеря кворума останавливает AG. Важно правильно настраивать голоса узлов и свидетеля (файловый ресурс или Azure Cloud Witness).
*   **Сетевые задержки:** При синхронной репликации напрямую влияют на производительность записи. Критично для географически распределенных реплик.
*   **Превышение RPO:** При асинхронной репликации вторичная реплика может отставать (lag). При сбое первичной данные, не пересланные на вторичную, будут потеряны.
*   **"Узкое место" на первичной:** Все данные для вторичных реплик проходят через один поток отправки логов (per database). Много БД или большая нагрузка — может возникнуть очередь отправки (send queue).
*   **"Узкое место" на вторичной:** Поток повтора (redo) может не успевать применять журналы, особенно при больших операциях (индексация, массовые вставки). Важен мониторинг `redo_queue_size`.
*   **Проблемы с прослушивателем:** DNS-кеширование, неправильные IP/маски подсетей, firewall.
*   **Ошибка "Database is not joined":** Частая проблема при добавлении БД, если не восстановлена последняя журнальная резервная копия перед присоединением.
*   **Темпоральные таблицы и `IDENTITY`:** Данные временных таблиц (`#temp`) не реплицируются. Столбцы `IDENTITY` могут вызвать конфликты при работе с readable secondary, если не использовать диапазоны.

### **5. Возможные вопросы к собеседованию (с ответами)**

### **Базовый уровень**

#### **1. В чем разница между AlwaysOn Availability Group и Failover Cluster Instance?**
**Ответ (структурный):**
Это два разных уровня решения.
*   **AlwaysOn Failover Cluster Instance (FCI)** — это решение **высокой доступности (High Availability) на уровне экземпляра SQL Server**. Он основан на Windows Server Failover Clustering (WSFC) и **требует общего хранилища** (SAN, iSCSI и т.д.). Активен только один узел, который владеет общими дисками. При сбое происходит переезд *всего экземпляра SQL Server* (со всеми системными БД) на другой узел кластера. Защищает от сбоя сервера, ОС, но **не защищает от повреждения данных на общем хранилище**.
*   **AlwaysOn Availability Group (AG)** — это решение **и высокой доступности, и аварийного восстановления (Disaster Recovery) на уровне базы данных (или группы БД)**. Каждая реплика (узел) имеет **свою собственную копию данных** на локальном хранилище. Данные реплицируются путем пересылки и применения записей журнала транзакций. Позволяет использовать вторичные реплики для чтения и резервного копирования.

**Ключевая аналогия:** FCI — это "переезд всего дома на другой фундамент" (shared storage). AG — это "синхронизированные копии документов в нескольких сейфах" (replicated data).

#### **2. Объясните разницу между синхронной и асинхронной репликацией. Каковы trade-offs?**
**Ответ:**
Разница в моменте подтверждения фиксации транзакции клиенту.
*   **Синхронная фиксация (Synchronous Commit):** Первичная реплика ждет подтверждения от вторичной, что та **записала транзакцию в свой журнал транзакций на диск**, и только после этого сама фиксирует транзакцию и отправляет подтверждение клиенту.
    *   **Плюс:** Гарантия **zero data loss** (при отработке отказа на эту синхронную реплику).
    *   **Минус:** Увеличивает задержку ответа клиенту (латентность), так как зависит от скорости сети и дисков вторичной реплики. Производительность операций записи снижается.
*   **Асинхронная фиксация (Asynchronous Commit):** Первичная реплика фиксирует транзакцию **немедленно**, не дожидаясь ответа от вторичной, и затем в фоне отправляет ей записи лога.
    *   **Плюс:** Минимальное влияние на производительность операций записи на первичной реплике.
    *   **Минус:** Возможна **потеря данных (data loss)** при сбое первичной, так как последние зафиксированные транзакции могли не успеть попасть на вторичную реплику.

**Trade-off:** **Задержка vs. защита данных.** Синхронная используется для реплик в одном ЦОДе (для HA), асинхронная — для удаленных ЦОДов (для DR), где сетевые задержки велики.

#### **3. Что такое прослушиватель (Listener) и для чего он нужен?**
**Ответ:**
Прослушиватель группы доступности — это виртуальное сетевое имя (VNN) и один или несколько виртуальных IP-адресов, которые представляют группу доступности как единую точку входа для клиентских приложений.
*   **Для чего:** Он обеспечивает **прозрачное перенаправление подключений** после отработки отказа (failover). Клиенты подключаются не к физическому имени сервера, а к имени прослушивателя. При смене первичной реплики прослушиватель автоматически обновляет свою привязку к IP-адресу нового первичного узла (на уровне WSFC). Клиентское соединение разрывается, но при повторном подключении (с тем же именем прослушивателя) клиент попадет уже на новую первичную реплику.
*   **Важный нюанс:** Для работы с вторичными репликами, доступными для чтения, в строке подключения необходимо указывать параметр `ApplicationIntent=ReadOnly`. Тогда драйвер, подключаясь через прослушиватель, будет перенаправлен на одну из доступных для чтения вторичных реплик.

#### **4. Как обеспечить отказоустойчивость для одной базы данных на 3 узла с гарантией отсутствия потерь данных при сбое одного узла?**
**Ответ (практический):**
Нужно развернуть AlwaysOn Availability Group с **тремя репликами**.
1.  **Первичная реплика:** Назначается в режиме **синхронной фиксации (Synchronous Commit)**.
2.  **Вторичная реплика #1:** Располагается в том же ЦОДе, что и первичная, в режиме **синхронной фиксации** с включенным **автоматическим переходом на другой ресурс при сбое (Automatic Failover)**. Это обеспечивает HA без потерь данных.
3.  **Вторичная реплика #2:** Может располагаться в том же или другом ЦОДе. В зависимости от требований к RPO:
    *   Если нужна максимальная защита в пределах RTO, можно также сделать её **синхронной** (конфигурация "большинство узлов" для кворума).
    *   Если допустима небольшая потеря данных и важна производительность записи/задержка, можно сделать её **асинхронной (Asynchronous Commit)**. Она будет служить для DR.

**Гарантия zero data loss** обеспечивается тем, что фиксация транзакции на первичной реплике происходит только после подтверждения от **минимум одной синхронной вторичной реплики**.

#### **5. Можно ли делать резервные копии с вторичной реплики? Какие?**
**Ответ:**
**Да, можно, но с ограничениями.**
*   **Полные и разностные резервные копии (FULL/DIFF):** Можно делать на вторичной реплике **только если** она настроена как реплика, разрешенная для резервного копирования (в свойствах AG), и вы явно указали предпочтение в настройках резервного копирования для AG. SQL Server будет автоматически выбирать реплику для выполнения задания бэкапа в соответствии с этими настройками.
*   **Резервные копии журналов транзакций (LOG):** **НЕЛЬЗЯ** делать на вторичной реплике. Цепочка журналов транзакций управляется исключительно первичной репликой. Резервное копирование журналов должно выполняться **только на первичной реплике**. Попытка создать бэкап лога на вторичной завершится ошибкой.

**Преимущество:** Разгрузка первичной реплики от нагрузки операций резервного копирования.

---

### **Продвинутый уровень**

#### **1. Опишите процесс планового обновления (patching) сервера в конфигурации AG.**
**Ответ (пошаговый rolling update):**
1.  **Подготовка:** Убедиться, что все синхронные реплики находятся в состоянии `SYNCHRONIZED`. Создать полную резервную копию.
2.  **Шаг 1 — Обновление вторичной синхронной реплики:**
    *   Применить патч/обновление Windows/SQL Server к **одной из вторичных синхронных реплик**.
    *   Перезагрузить сервер при необходимости.
    *   Убедиться, что служба SQL Server запущена и реплика перешла в состояние `SYNCHRONIZED`.
3.  **Шаг 2 — Отработка отказа (Manual Failover):**
    *   Выполнить **плановый переход вручную (manual failover)** на только что обновленную реплику. Она станет новой первичной.
    *   Убедиться, что приложения переподключились через прослушиватель и работают.
4.  **Шаг 3 — Обновление бывшей первичной реплики:**
    *   Теперь старая первичная реплика стала вторичной. Применить к ней патч/обновление.
    *   Перезагрузить.
5.  **Повторение:** Если реплик больше двух, повторить шаги 1-3 для остальных реплик по очереди.
6.  **Возврат (опционально):** Если требуется вернуться на исходную первичную реплику, выполнить еще один плановый manual failover.

**Важно:** Для автоматического failover нужно как минимум две синхронные реплики (обновляемая и текущая первичная). Во время обновления одной из них автоматический failover будет невозможен.

#### **2. Как вы будете диагностировать и устранять отставание (lag) вторичной реплики?**
**Ответ:**
Отставание (лаг) бывает двух видов, их нужно диагностировать отдельно через DMV `sys.dm_hadr_database_replica_states`:
*   **Очередь отправки (Send Queue / log send queue):** Неотправленные записи журнала на первичной реплике (`log_send_queue_size`, КБ). Проблема **на стороне первичной**.
    *   **Причины:** Сетевая перегрузка, недостаточная пропускная способность сети, высокая нагрузка на диски первичной реплики.
    *   **Устранение:** Мониторинг сети, проверка нагрузки на диск, возможно, настройка сетевого QoS.
*   **Очередь повтора (Redo Queue):** Журналы, полученные вторичной репликой, но еще не примененные к данным (`redo_queue_size`, КБ). Проблема **на стороне вторичной**.
    *   **Причины:** Нехватка CPU/IO на вторичной реплике (особенно если она активно используется для чтения), блокировки на вторичной БД, большие транзакции (например, массовые вставки/обновления).
    *   **Устранение:** Оптимизация нагрузки на readable secondary (индексы, запросы), добавление ресурсов (CPU, более быстрые диски), проверка на наличие блокировок.

**Общий план:** 1) Определить, какая очередь растет. 2) Снять метрики нагрузки (PerfMon: CPU, Disk Avg. Sec/Write-Read, сеть). 3) Проанализировать активные запросы на проблемной реплике.

#### **3. Что такое кворум WSFC и почему он важен для AG? Какие варианты кворума вы знаете?**
**Ответ:**
*   **Что такое:** Кворум в WSFC — это механизм **предотвращения "раскола" кластера (split-brain)**, когда узлы из-за сетевого сбоя теряют связь друг с другом и каждый считает себя активным. Кворум определяет, какая часть кластера имеет право продолжать работу.
*   **Важность для AG:** Если кластер теряет кворум, **все ресурсы кластера, включая группы доступности, останавливаются**. Это защитная мера, предотвращающая запись в базы данных с двух "первичных" реплик в разных частях сети.
*   **Варианты голосования кворума (начиная с SQL 2012):**
    1.  **Кворум большинства узлов:** Подходит для кластеров с нечетным числом узлов (3, 5, 7). Каждый узел имеет один голос.
    2.  **Кворум большинства узлов и общих дисков:** Узел-свидетель — общий диск (File Share Witness). Подходит для кластеров с четным числом узлов (2, 4). Общий диск дает решающий голос.
    3.  **Кворум большинства узлов и файлового ресурса:** Наиболее популярный для 2 узлов. Специальная файловая папка (FSW) на файловом сервере выступает свидетелем.
    4.  **Облачный следящий сервер (Cloud Witness):** Для гибридных или чистых Azure-сред. В качестве свидетеля используется Azure Blob Storage. Самый отказоустойчивый и современный вариант.

#### **4. Клиент жалуется на таймауты при подключении к прослушивателю после failover. В чем могут быть причины?**
**Ответ (чек-лист):**
1.  **DNS-кеширование:** Клиентская машина или промежуточный сетевой элемент закешировали старый IP-адрес прослушивателя. `ipconfig /flushdns` на клиенте.
2.  **Параметр `MultiSubnetFailover=True` не указан:** Если прослушиватель имеет IP-адреса в разных подсетях (разные сайты/ЦОДы), и после failover активный IP сменил подсеть, старые драйверы без этого параметра будут долго ждать таймаута ARP-запроса в старой подсети. Параметр `MultiSubnetFailover=True` в строке подключения решает эту проблему.
3.  **Проблемы с регистрацией DNS:** Кластеру не удалось обновить DNS-запись для имени прослушивателя (недостаточно прав, проблемы с DNS-сервером).
4.  **Фаерволл:** После failover новый узел может иметь другие правила фаервола, блокирующие порт прослушивателя (по умолчанию 1433) или порт зеркального эндпоинта (5022).
5.  **Долгий процесс восстановления БД:** После failover новая первичная реплика проходит фазу `UNDO` (откат незафиксированных транзакций). В это время база данных находится в состоянии `RECOVERING` и недоступна для подключений.

#### **5. Какие ограничения имеют readable secondary реплики?**
**Ответ:**
*   **Изоляция моментальных снимков (Snapshot Isolation):** Все запросы на вторичной реплике выполняются с уровнем изоляции `SNAPSHOT` по умолчанию. Это может привести к дополнительному потреблению места в `tempdb` для хранения версий строк.
*   **Статистика:** Статистика по индексам/таблицам **не реплицируется**. Запросы на вторичной реплике используют локальную статистику, которая может устареть, что приведет к неоптимальным планам запросов. Требуется периодическое обновление статистики на вторичной реплике (через планы обслуживания).
*   **Темпоральные таблицы (#temp):** Локальные временные таблицы, созданные на первичной реплике, **не видны** на вторичной. На вторичной реплике каждая сессия работает со своими временными таблицами.
*   **Динамические административные представления (DMV):** Некоторые DMV, показывающие информацию о блокировках, сессиях, выполняемых запросах, отображают данные **только для текущей реплики**, а не для всей группы доступности.
*   **Задержка данных (Data Latency):** Данные на вторичной реплике всегда немного отстают от первичной (даже в синхронном режиме, так как есть задержка на применение лога — REDO).

#### **6. Что такое распределенная группа доступности (Distributed AG) и какой сценарий она решает?**
**Ответ:**
Распределенная AG (DAG) — это "аг над агами". Она связывает **две отдельные группы доступности** (каждая со своими репликами), которые могут находиться в **разных географических локациях, разных доменах или даже на разных платформах (Windows/Linux, начиная с SQL 2019)**.
*   **Как работает:** Одна AG (напр., в ЦОД 1) является **первичной**, а другая AG (в ЦОД 2) — **вторичной** в рамках распределенной AG. Репликация происходит между этими AG, а не напрямую между всеми репликами.
*   **Ключевой сценарий:**
    1.  **Миграция без простоя:** Можно выполнить плановый переход всей распределенной AG на вторую AG в другом месте, что эффективно для миграции между центрами данных или в облако.
    2.  **Многосайтовая DR:** Организация аварийного восстановления между двумя полностью независимыми кластерами WSFC (или Pacemaker на Linux).
*   **Важно:** Клиенты подключаются к прослушивателю своей локальной AG. Для переключения на удаленную AG требуется изменение строки подключения на стороне приложения (или использование глобального балансировщика нагрузки).

#### **7. Как работает автоматический failover и что может его заблокировать?**
**Ответ:**
Автоматический failover срабатывает, когда система детектирует критический сбой на первичной реплике. Процесс:
1.  Кластер WSFC определяет, что узел с первичной репликой недоступен (health check).
2.  Кворум кластера пересчитывается.
3.  Если целевая вторичная реплика настроена с `FAILOVER_MODE = AUTOMATIC` и находится в состоянии **синхронной репликации (`SYNCHRONIZED`)**, кластер инициирует перенос роли первичной реплики на нее.
4.  Происходит короткая фаза `RESOLVING`, затем вторичная реплика переходит в роль `PRIMARY` и запускает восстановление БД (фаза UNDO).

**Что может заблокировать автоматический failover:**
*   Целевая вторичная реплика **не синхронизирована** (не в состоянии `SYNCHRONIZED`).
*   **Потеря кворума** в кластере WSFC.
*   Проблемы с **состоянием работоспособности (health) самой AG** (например, сбой эндпоинта, но кластер жив).
*   Наличие **подозреваемых данных (suspect pages)** на вторичной реплике.
*   Если вторичная реплика недоступна для соединения или ее служба SQL Server не запущена.
*   **Только для одной БД:** Если в группе несколько БД, и одна из них на целевой вторичной реплике не готова, failover может не произойти (зависит от настройки `DB_FAILOVER`).

---

**Следующий шаг:** С такими ответами вы уже отлично выглядите на собеседовании. Хотите теперь углубиться в какой-то конкретный раздел плана? Например, **нюансы настройки (п.3)** с разбором скриптов создания AG и прослушивателя?
